"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
// Models
const SystemConfig_1 = __importDefault(require("./models/SystemConfig"));
// Controllers
const pallets_1 = __importDefault(require("./controllers/pallets"));
const boxes_1 = __importDefault(require("./controllers/boxes"));
// Utils
const response_1 = __importDefault(require("./utils/response"));
const aws_sdk_1 = __importDefault(require("aws-sdk"));
const codepipeline = new aws_sdk_1.default.CodePipeline();
// Constants from models
const LOCATIONS = SystemConfig_1.default.getLocations();
const ITEM_TYPES = SystemConfig_1.default.getItemTypes();
const movePallet_1 = __importDefault(require("./handlers/movePallet"));
// Helper functions
const helpers = {
    parseBody: (event) => {
        if (!event.body)
            return {};
        try {
            return typeof event.body === 'string' ? JSON.parse(event.body) : event.body;
        }
        catch (_a) {
            throw new Error("Invalid request body: unable to parse JSON");
        }
    },
    getQueryParams: (event) => event.queryStringParameters || {},
    validateRequired: (data, requiredParams) => {
        const missing = requiredParams.filter((param) => !data[param]);
        if (missing.length > 0) {
            throw new Error(`Missing parameters: ${missing.join(", ")}`);
        }
    },
    validateLocation: (location, allowed) => {
        if (!allowed.includes(location)) {
            throw new Error(`Invalid location: ${location}. Valid options: ${allowed.join(", ")}`);
        }
    },
};
// Create a handler wrapper to standardize error handling
const createHandler = (handlerFn, options = {}) => {
    return async (event) => {
        try {
            return await handlerFn(event, options);
        }
        catch (error) {
            console.error("❌ Error in route handler:", error);
            return (0, response_1.default)(error.statusCode || 500, error.message);
        }
    };
};
// Define GET routes
const getRoutes = {
    "/getBodegaEggs": createHandler(async () => {
        return await boxes_1.default.read.getBoxesByLocation(LOCATIONS.BODEGA);
    }),
    "/getPackingData": createHandler(async () => {
        return await boxes_1.default.read.getBoxesByLocation(LOCATIONS.PACKING);
    }),
    "/getVentaData": createHandler(async () => {
        return await boxes_1.default.read.getBoxesByLocation(LOCATIONS.VENTA);
    }),
    "/getEggsByDate": createHandler(async (event) => {
        const { date } = helpers.getQueryParams(event);
        helpers.validateRequired({ date }, ['date']);
        return await boxes_1.default.read.getBoxesByDate(date);
    }),
    "/production": createHandler(async () => {
        return await boxes_1.default.read.getAllBoxes();
    }),
    "/getPallets": createHandler(async () => {
        return await pallets_1.default.read.getAllPallets();
    }),
    "/getActivePallets": createHandler(async () => {
        return await pallets_1.default.read.getActivePallets();
    }),
    // Add more GET routes as needed
};
const postRoutes = {
    "/movePallet": createHandler(async (event) => {
        const { codigo, ubicacion } = helpers.parseBody(event);
        helpers.validateRequired({ codigo, ubicacion }, ['codigo', 'ubicacion']);
        helpers.validateLocation(ubicacion, ["TRANSITO", "BODEGA", "VENTA"]);
        return await (0, movePallet_1.default)(codigo, ubicacion);
    }),
    // Add more POST routes as needed
};
const putRoutes = {
// PUT routes
};
const optionsRoutes = {
    // Handle all OPTIONS requests with a CORS-friendly response
    "*": async () => {
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'OPTIONS,GET,POST,PUT,DELETE',
                'Access-Control-Allow-Headers': 'Content-Type,Authorization,X-Amz-Date,X-Api-Key',
            },
            body: '',
        };
    }
};
const handler = async (event, context) => {
    // Handle CodePipeline events
    if ('CodePipeline.job' in event) {
        const jobId = event['CodePipeline.job'].id;
        try {
            // Logic for deployment operation here
            // Report success explicitly
            await codepipeline.putJobSuccessResult({ jobId }).promise();
        }
        catch (error) {
            console.error("❌ Error in Lambda execution from CodePipeline:", error);
            if (context) {
                await codepipeline.putJobFailureResult({
                    jobId,
                    failureDetails: {
                        message: JSON.stringify(error.message),
                        type: 'JobFailed',
                        externalExecutionId: context.awsRequestId,
                    },
                }).promise();
            }
        }
        return;
    }
    // Handle API Gateway events
    try {
        const lambdaEvent = event;
        console.log('Event received:', {
            method: lambdaEvent.httpMethod,
            path: lambdaEvent.path,
            queryParams: lambdaEvent.queryStringParameters,
            pathParams: lambdaEvent.pathParameters,
        });
        const method = lambdaEvent.httpMethod;
        const path = lambdaEvent.path;
        if (!method || !path) {
            return (0, response_1.default)(400, "Invalid request: missing method or path");
        }
        // Handle OPTIONS method for CORS preflight
        if (method === "OPTIONS") {
            return await optionsRoutes["*"]();
        }
        // Get the appropriate routes object based on HTTP method
        const routes = method === "GET" ? getRoutes :
            method === "POST" ? postRoutes :
                method === "PUT" ? putRoutes : null;
        if (!routes)
            return (0, response_1.default)(405, `Method not supported: ${method}`);
        // Try exact path match first
        let handler = routes[path];
        // If no handler found, return 404
        if (!handler) {
            return (0, response_1.default)(404, `Route not found: ${path}`);
        }
        console.log(`Invoking handler for ${method} ${path}`);
        return await handler(lambdaEvent);
    }
    catch (error) {
        console.error("❌ Unhandled Error:", error);
        return (0, response_1.default)(500, "Internal server error", { error: error.message });
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxTQUFTO0FBQ1QseUVBQWlEO0FBRWpELGNBQWM7QUFDZCxvRUFBc0Q7QUFDdEQsZ0VBQWtEO0FBR2xELFFBQVE7QUFDUixnRUFBaUQ7QUFDakQsc0RBQTBCO0FBRzFCLE1BQU0sWUFBWSxHQUFHLElBQUksaUJBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztBQUU1Qyx3QkFBd0I7QUFDeEIsTUFBTSxTQUFTLEdBQUcsc0JBQVksQ0FBQyxZQUFZLEVBQUUsQ0FBQztBQUM5QyxNQUFNLFVBQVUsR0FBRyxzQkFBWSxDQUFDLFlBQVksRUFBRSxDQUFDO0FBSy9DLHVFQUErQztBQUUvQyxtQkFBbUI7QUFDbkIsTUFBTSxPQUFPLEdBQUc7SUFDZCxTQUFTLEVBQUUsQ0FBQyxLQUFrQixFQUF1QixFQUFFO1FBQ3JELElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSTtZQUFFLE9BQU8sRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQztZQUNILE9BQU8sT0FBTyxLQUFLLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7UUFDOUUsQ0FBQztRQUFDLFdBQU0sQ0FBQztZQUNQLE1BQU0sSUFBSSxLQUFLLENBQUMsNENBQTRDLENBQUMsQ0FBQztRQUNoRSxDQUFDO0lBQ0gsQ0FBQztJQUNELGNBQWMsRUFBRSxDQUFDLEtBQWtCLEVBQTBCLEVBQUUsQ0FBQyxLQUFLLENBQUMscUJBQXFCLElBQUksRUFBRTtJQUNqRyxnQkFBZ0IsRUFBRSxDQUFDLElBQXlCLEVBQUUsY0FBd0IsRUFBUSxFQUFFO1FBQzlFLE1BQU0sT0FBTyxHQUFHLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUs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LENBQUM7SUFDOUYsQ0FBQztBQUNILENBQUMsQ0FBQztBQTFFVyxRQUFBLE9BQU8sV0EwRWxCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTW9kZWxzXG5pbXBvcnQgU3lzdGVtQ29uZmlnIGZyb20gJy4vbW9kZWxzL1N5c3RlbUNvbmZpZyc7XG5cbi8vIENvbnRyb2xsZXJzXG5pbXBvcnQgcGFsbGV0c0NvbnRyb2xsZXIgZnJvbSAnLi9jb250cm9sbGVycy9wYWxsZXRzJztcbmltcG9ydCBib3hlc0NvbnRyb2xsZXIgZnJvbSAnLi9jb250cm9sbGVycy9ib3hlcyc7XG5pbXBvcnQgYWRtaW5Db250cm9sbGVyIGZyb20gJy4vY29udHJvbGxlcnMvYWRtaW4nO1xuXG4vLyBVdGlsc1xuaW1wb3J0IGNyZWF0ZUFwaVJlc3BvbnNlIGZyb20gJy4vdXRpbHMvcmVzcG9uc2UnO1xuaW1wb3J0IEFXUyBmcm9tICdhd3Mtc2RrJztcbmltcG9ydCB7IExhbWJkYUV2ZW50LCBBcGlSZXNwb25zZSwgTG9jYXRpb24gfSBmcm9tICcuL3R5cGVzJztcblxuY29uc3QgY29kZXBpcGVsaW5lID0gbmV3IEFXUy5Db2RlUGlwZWxpbmUoKTtcblxuLy8gQ29uc3RhbnRzIGZyb20gbW9kZWxzXG5jb25zdCBMT0NBVElPTlMgPSBTeXN0ZW1Db25maWcuZ2V0TG9jYXRpb25zKCk7XG5jb25zdCBJVEVNX1RZUEVTID0gU3lzdGVtQ29uZmlnLmdldEl0ZW1UeXBlcygpO1xuXG4vLyBJbXBvcnQgdGhlIGhhbmRsZXJzIHdpdGggdGhlIG5ldyBuYW1lc1xuaW1wb3J0IHJlZ2lzdGVyQm94IGZyb20gJy4vaGFuZGxlcnMvcmVnaXN0ZXJCb3gnO1xuaW1wb3J0IG1vdmVCb3ggZnJvbSAnLi9oYW5kbGVycy9tb3ZlQm94JztcbmltcG9ydCBtb3ZlUGFsbGV0IGZyb20gJy4vaGFuZGxlcnMvbW92ZVBhbGxldCc7XG5cbi8vIEhlbHBlciBmdW5jdGlvbnNcbmNvbnN0IGhlbHBlcnMgPSB7XG4gIHBhcnNlQm9keTogKGV2ZW50OiBMYW1iZGFFdmVudCk6IFJlY29yZDxzdHJpbmcsIGFueT4gPT4ge1xuICAgIGlmICghZXZlbnQuYm9keSkgcmV0dXJuIHt9O1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gdHlwZW9mIGV2ZW50LmJvZHkgPT09ICdzdHJpbmcnID8gSlNPTi5wYXJzZShldmVudC5ib2R5KSA6IGV2ZW50LmJvZHk7XG4gICAgfSBjYXRjaCB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIHJlcXVlc3QgYm9keTogdW5hYmxlIHRvIHBhcnNlIEpTT05cIik7XG4gICAgfVxuICB9LFxuICBnZXRRdWVyeVBhcmFtczogKGV2ZW50OiBMYW1iZGFFdmVudCk6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPT4gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzIHx8IHt9LFxuICB2YWxpZGF0ZVJlcXVpcmVkOiAoZGF0YTogUmVjb3JkPHN0cmluZywgYW55PiwgcmVxdWlyZWRQYXJhbXM6IHN0cmluZ1tdKTogdm9pZCA9PiB7XG4gICAgY29uc3QgbWlzc2luZyA9IHJlcXVpcmVkUGFyYW1zLmZpbHRlcigocGFyYW0pID0+ICFkYXRhW3BhcmFtXSk7XG4gICAgaWYgKG1pc3NpbmcubGVuZ3RoID4gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIHBhcmFtZXRlcnM6ICR7bWlzc2luZy5qb2luKFwiLCBcIil9YCk7XG4gICAgfVxuICB9LFxuICB2YWxpZGF0ZUxvY2F0aW9uOiAobG9jYXRpb246IHN0cmluZywgYWxsb3dlZDogc3RyaW5nW10pOiB2b2lkID0+IHtcbiAgICBpZiAoIWFsbG93ZWQuaW5jbHVkZXMobG9jYXRpb24pKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgbG9jYXRpb246ICR7bG9jYXRpb259LiBWYWxpZCBvcHRpb25zOiAke2FsbG93ZWQuam9pbihcIiwgXCIpfWApO1xuICAgIH1cbiAgfSxcbn07XG5cbi8vIENyZWF0ZSBhIGhhbmRsZXIgd3JhcHBlciB0byBzdGFuZGFyZGl6ZSBlcnJvciBoYW5kbGluZ1xuY29uc3QgY3JlYXRlSGFuZGxlciA9IChcbiAgaGFuZGxlckZuOiAoZXZlbnQ6IExhbWJkYUV2ZW50LCBvcHRpb25zPzogYW55KSA9PiBQcm9taXNlPGFueT4sXG4gIG9wdGlvbnM6IGFueSA9IHt9XG4pID0+IHtcbiAgcmV0dXJuIGFzeW5jIChldmVudDogTGFtYmRhRXZlbnQpOiBQcm9taXNlPEFwaVJlc3BvbnNlPiA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCBoYW5kbGVyRm4oZXZlbnQsIG9wdGlvbnMpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwi4p2MIEVycm9yIGluIHJvdXRlIGhhbmRsZXI6XCIsIGVycm9yKTtcbiAgICAgIHJldHVybiBjcmVhdGVBcGlSZXNwb25zZSgoZXJyb3IgYXMgYW55KS5zdGF0dXNDb2RlIHx8IDUwMCwgKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlKTtcbiAgICB9XG4gIH07XG59O1xuXG4vLyBEZWZpbmUgR0VUIHJvdXRlc1xuY29uc3QgZ2V0Um91dGVzOiBSZWNvcmQ8c3RyaW5nLCAoZXZlbnQ6IExhbWJkYUV2ZW50KSA9PiBQcm9taXNlPEFwaVJlc3BvbnNlPj4gPSB7XG4gIFwiL2dldEJvZGVnYUVnZ3NcIjogY3JlYXRlSGFuZGxlcihhc3luYyAoKSA9PiB7XG4gICAgcmV0dXJuIGF3YWl0IGJveGVzQ29udHJvbGxlci5yZWFkLmdldEJveGVzQnlMb2NhdGlvbihMT0NBVElPTlMuQk9ERUdBKTtcbiAgfSksXG4gIFxuICBcIi9nZXRQYWNraW5nRGF0YVwiOiBjcmVhdGVIYW5kbGVyKGFzeW5jICgpID0+IHtcbiAgICByZXR1cm4gYXdhaXQgYm94ZXNDb250cm9sbGVyLnJlYWQuZ2V0Qm94ZXNCeUxvY2F0aW9uKExPQ0FUSU9OUy5QQUNLSU5HKTtcbiAgfSksXG4gIFxuICBcIi9nZXRWZW50YURhdGFcIjogY3JlYXRlSGFuZGxlcihhc3luYyAoKSA9PiB7XG4gICAgcmV0dXJuIGF3YWl0IGJveGVzQ29udHJvbGxlci5yZWFkLmdldEJveGVzQnlMb2NhdGlvbihMT0NBVElPTlMuVkVOVEEpO1xuICB9KSxcbiAgXG4gIFwiL2dldEVnZ3NCeURhdGVcIjogY3JlYXRlSGFuZGxlcihhc3luYyAoZXZlbnQpID0+IHtcbiAgICBjb25zdCB7IGRhdGUgfSA9IGhlbHBlcnMuZ2V0UXVlcnlQYXJhbXMoZXZlbnQpO1xuICAgIGhlbHBlcnMudmFsaWRhdGVSZXF1aXJlZCh7IGRhdGUgfSwgWydkYXRlJ10pO1xuICAgIHJldHVybiBhd2FpdCBib3hlc0NvbnRyb2xsZXIucmVhZC5nZXRCb3hlc0J5RGF0ZShkYXRlKTtcbiAgfSksXG4gIFxuICBcIi9wcm9kdWN0aW9uXCI6IGNyZWF0ZUhhbmRsZXIoYXN5bmMgKCkgPT4ge1xuICAgIHJldHVybiBhd2FpdCBib3hlc0NvbnRyb2xsZXIucmVhZC5nZXRBbGxCb3hlcygpO1xuICB9KSxcbiAgXG4gIFwiL2dldFBhbGxldHNcIjogY3JlYXRlSGFuZGxlcihhc3luYyAoKSA9PiB7XG4gICAgcmV0dXJuIGF3YWl0IHBhbGxldHNDb250cm9sbGVyLnJlYWQuZ2V0QWxsUGFsbGV0cygpO1xuICB9KSxcbiAgXG4gIFwiL2dldEFjdGl2ZVBhbGxldHNcIjogY3JlYXRlSGFuZGxlcihhc3luYyAoKSA9PiB7XG4gICAgcmV0dXJuIGF3YWl0IHBhbGxldHNDb250cm9sbGVyLnJlYWQuZ2V0QWN0aXZlUGFsbGV0cygpO1xuICB9KSxcblxuICAvLyBBZGQgbW9yZSBHRVQgcm91dGVzIGFzIG5lZWRlZFxufTtcblxuY29uc3QgcG9zdFJvdXRlczogUmVjb3JkPHN0cmluZywgKGV2ZW50OiBMYW1iZGFFdmVudCkgPT4gUHJvbWlzZTxBcGlSZXNwb25zZT4+ID0ge1xuICBcIi9tb3ZlUGFsbGV0XCI6IGNyZWF0ZUhhbmRsZXIoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgY29uc3QgeyBjb2RpZ28sIHViaWNhY2lvbiB9ID0gaGVscGVycy5wYXJzZUJvZHkoZXZlbnQpO1xuICAgIGhlbHBlcnMudmFsaWRhdGVSZXF1aXJlZCh7IGNvZGlnbywgdWJpY2FjaW9uIH0sIFsnY29kaWdvJywgJ3ViaWNhY2lvbiddKTtcbiAgICBoZWxwZXJzLnZhbGlkYXRlTG9jYXRpb24odWJpY2FjaW9uLCBbXCJUUkFOU0lUT1wiLCBcIkJPREVHQVwiLCBcIlZFTlRBXCJdKTtcbiAgICByZXR1cm4gYXdhaXQgbW92ZVBhbGxldChjb2RpZ28sIHViaWNhY2lvbiBhcyBMb2NhdGlvbik7XG4gIH0pLFxuXG4gIC8vIEFkZCBtb3JlIFBPU1Qgcm91dGVzIGFzIG5lZWRlZFxufTtcblxuY29uc3QgcHV0Um91dGVzOiBSZWNvcmQ8c3RyaW5nLCAoZXZlbnQ6IExhbWJkYUV2ZW50KSA9PiBQcm9taXNlPEFwaVJlc3BvbnNlPj4gPSB7XG4gIC8vIFBVVCByb3V0ZXNcbn07XG5cbmNvbnN0IG9wdGlvbnNSb3V0ZXM6IFJlY29yZDxzdHJpbmcsICgpID0+IFByb21pc2U8QXBpUmVzcG9uc2U+PiA9IHtcbiAgLy8gSGFuZGxlIGFsbCBPUFRJT05TIHJlcXVlc3RzIHdpdGggYSBDT1JTLWZyaWVuZGx5IHJlc3BvbnNlXG4gIFwiKlwiOiBhc3luYyAoKSA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMnOiAnT1BUSU9OUyxHRVQsUE9TVCxQVVQsREVMRVRFJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24sWC1BbXotRGF0ZSxYLUFwaS1LZXknLFxuICAgICAgfSxcbiAgICAgIGJvZHk6ICcnLFxuICAgIH07XG4gIH1cbn07XG5cbmludGVyZmFjZSBDb2RlUGlwZWxpbmVFdmVudCB7XG4gICdDb2RlUGlwZWxpbmUuam9iJzoge1xuICAgIGlkOiBzdHJpbmc7XG4gIH07XG59XG5cbmludGVyZmFjZSBDb2RlUGlwZWxpbmVDb250ZXh0IHtcbiAgYXdzUmVxdWVzdElkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogTGFtYmRhRXZlbnQgfCBDb2RlUGlwZWxpbmVFdmVudCxcbiAgY29udGV4dD86IENvZGVQaXBlbGluZUNvbnRleHRcbik6IFByb21pc2U8QXBpUmVzcG9uc2UgfCB2b2lkPiA9PiB7XG5cbiAgLy8gSGFuZGxlIENvZGVQaXBlbGluZSBldmVudHNcbiAgaWYgKCdDb2RlUGlwZWxpbmUuam9iJyBpbiBldmVudCkge1xuICAgIGNvbnN0IGpvYklkID0gZXZlbnRbJ0NvZGVQaXBlbGluZS5qb2InXS5pZDtcbiAgICB0cnkge1xuICAgICAgLy8gTG9naWMgZm9yIGRlcGxveW1lbnQgb3BlcmF0aW9uIGhlcmVcblxuICAgICAgLy8gUmVwb3J0IHN1Y2Nlc3MgZXhwbGljaXRseVxuICAgICAgYXdhaXQgY29kZXBpcGVsaW5lLnB1dEpvYlN1Y2Nlc3NSZXN1bHQoeyBqb2JJZCB9KS5wcm9taXNlKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCLinYwgRXJyb3IgaW4gTGFtYmRhIGV4ZWN1dGlvbiBmcm9tIENvZGVQaXBlbGluZTpcIiwgZXJyb3IpO1xuICAgICAgaWYgKGNvbnRleHQpIHtcbiAgICAgICAgYXdhaXQgY29kZXBpcGVsaW5lLnB1dEpvYkZhaWx1cmVSZXN1bHQoe1xuICAgICAgICAgIGpvYklkLFxuICAgICAgICAgIGZhaWx1cmVEZXRhaWxzOiB7XG4gICAgICAgICAgICBtZXNzYWdlOiBKU09OLnN0cmluZ2lmeSgoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UpLFxuICAgICAgICAgICAgdHlwZTogJ0pvYkZhaWxlZCcsXG4gICAgICAgICAgICBleHRlcm5hbEV4ZWN1dGlvbklkOiBjb250ZXh0LmF3c1JlcXVlc3RJZCxcbiAgICAgICAgICB9LFxuICAgICAgICB9KS5wcm9taXNlKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gSGFuZGxlIEFQSSBHYXRld2F5IGV2ZW50c1xuICB0cnkge1xuICAgIGNvbnN0IGxhbWJkYUV2ZW50ID0gZXZlbnQgYXMgTGFtYmRhRXZlbnQ7XG4gICAgY29uc29sZS5sb2coJ0V2ZW50IHJlY2VpdmVkOicsIHtcbiAgICAgIG1ldGhvZDogbGFtYmRhRXZlbnQuaHR0cE1ldGhvZCxcbiAgICAgIHBhdGg6IGxhbWJkYUV2ZW50LnBhdGgsXG4gICAgICBxdWVyeVBhcmFtczogbGFtYmRhRXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzLFxuICAgICAgcGF0aFBhcmFtczogbGFtYmRhRXZlbnQucGF0aFBhcmFtZXRlcnMsXG4gICAgfSk7XG5cbiAgICBjb25zdCBtZXRob2QgPSBsYW1iZGFFdmVudC5odHRwTWV0aG9kO1xuICAgIGNvbnN0IHBhdGggPSBsYW1iZGFFdmVudC5wYXRoO1xuXG4gICAgaWYgKCFtZXRob2QgfHwgIXBhdGgpIHtcbiAgICAgIHJldHVybiBjcmVhdGVBcGlSZXNwb25zZSg0MDAsIFwiSW52YWxpZCByZXF1ZXN0OiBtaXNzaW5nIG1ldGhvZCBvciBwYXRoXCIpO1xuICAgIH1cblxuICAgIC8vIEhhbmRsZSBPUFRJT05TIG1ldGhvZCBmb3IgQ09SUyBwcmVmbGlnaHRcbiAgICBpZiAobWV0aG9kID09PSBcIk9QVElPTlNcIikge1xuICAgICAgcmV0dXJuIGF3YWl0IG9wdGlvbnNSb3V0ZXNbXCIqXCJdKCk7XG4gICAgfVxuXG4gICAgLy8gR2V0IHRoZSBhcHByb3ByaWF0ZSByb3V0ZXMgb2JqZWN0IGJhc2VkIG9uIEhUVFAgbWV0aG9kXG4gICAgY29uc3Qgcm91dGVzID0gXG4gICAgICBtZXRob2QgPT09IFwiR0VUXCIgPyBnZXRSb3V0ZXMgOiBcbiAgICAgIG1ldGhvZCA9PT0gXCJQT1NUXCIgPyBwb3N0Um91dGVzIDogXG4gICAgICBtZXRob2QgPT09IFwiUFVUXCIgPyBwdXRSb3V0ZXMgOiBudWxsO1xuICAgICAgXG4gICAgaWYgKCFyb3V0ZXMpIHJldHVybiBjcmVhdGVBcGlSZXNwb25zZSg0MDUsIGBNZXRob2Qgbm90IHN1cHBvcnRlZDogJHttZXRob2R9YCk7XG5cbiAgICAvLyBUcnkgZXhhY3QgcGF0aCBtYXRjaCBmaXJzdFxuICAgIGxldCBoYW5kbGVyID0gcm91dGVzW3BhdGhdO1xuICAgIFxuICAgIC8vIElmIG5vIGhhbmRsZXIgZm91bmQsIHJldHVybiA0MDRcbiAgICBpZiAoIWhhbmRsZXIpIHtcbiAgICAgIHJldHVybiBjcmVhdGVBcGlSZXNwb25zZSg0MDQsIGBSb3V0ZSBub3QgZm91bmQ6ICR7cGF0aH1gKTtcbiAgICB9XG5cbiAgICBjb25zb2xlLmxvZyhgSW52b2tpbmcgaGFuZGxlciBmb3IgJHttZXRob2R9ICR7cGF0aH1gKTtcbiAgICByZXR1cm4gYXdhaXQgaGFuZGxlcihsYW1iZGFFdmVudCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihcIuKdjCBVbmhhbmRsZWQgRXJyb3I6XCIsIGVycm9yKTtcbiAgICByZXR1cm4gY3JlYXRlQXBpUmVzcG9uc2UoNTAwLCBcIkludGVybmFsIHNlcnZlciBlcnJvclwiLCB7IGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfSk7XG4gIH1cbn07ICJdfQ==